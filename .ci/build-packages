#!/usr/bin/env bash

set -euo pipefail 

_BUILD_PKGS="${_BUILD_PKGS:-\
    mageops-release \
    varnish-release \
    nginx-release \
    mariadb-release \
    elasticsearch-release \
    rabbitmq-release \
    nodejs-release \
    awscli \
    aws-excfwd \
    amazon-efs-utils \
    varnish-modules-extra \
    varnish-module-accept
}"

_DOCKER_TAG="${_DOCKER_TAG:-mageops/rpm-build:centos-7}"
# _DOCKER_RUN_DEBUGGING_OPTS="--volume $(pwd)/.docker/usr/local/bin/rpmbuild-mgs:/usr/local/bin/rpmbuild-mgs --interactive"

set -x

docker run \
    --rm \
    --name mgs-rpm-builder \
    --tty \
    --volume $(pwd):/root/rpmbuild \
    --env MGS_RPM_GPG_KEY_PASSPHRASE="${MGS_RPM_GPG_KEY_PASSPHRASE}" \
    --env MGS_RPMBUILD_OVERWRITE_EXISTING_REPO=${MGS_RPMBUILD_OVERWRITE_EXISTING_REPO:-no} \
    ${_DOCKER_RUN_DEBUGGING_OPTS:-} \
    "$_DOCKER_TAG" --sign --create-repo $_BUILD_PKGS
