#!/usr/bin/env bash

set -euo pipefail

_REPODIR="/usr/local/share/rpmbuild-mgs/repo"
_REPOENABLE=0

if [[ "$1" == "--enable" ]] ; then
    _REPOENABLE=1
    shift
fi

_REPOS="$@"

rpmbuild-mgs-dnf-shim-setup

for _REPO in $_REPOS ; do
    _REPOFILE="$_REPODIR/$_REPO.repo"
    _REPOPKGS="$_REPODIR/$_REPO.packages"

    echo -e "\n--- Installing repository $_REPO ---\n"
    ln -snvf "$_REPOFILE" "/etc/yum.repos.d/$_REPO.repo"

    echo -e "\n--- Warming up repository $_REPO cache ---\n"
    dnf -q makecache -y '--disablerepo=*' "--enablerepo=$_REPO"

    echo -e "\n--- Predownloading repository $_REPO packages ---\n"
    dnf -y install "--enablerepo=$_REPO" --downloadonly `cat "$_REPOPKGS"`

    if [[ $_REPOENABLE -gt 0 ]] ; then
        echo -e "\n--- Enabling repository $_REPO ---\n"
        dnf config-manager --enable "$_REPO"

        echo -e "\n--- Installing repository $_REPO packages ---\n"
        dnf -y install `cat "$_REPOPKGS"`
    fi
done